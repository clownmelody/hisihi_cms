define(["zepto","common"],function(){function e(e,t){this.$wrapper=e;var n=this;this.oid=t,this.pageIndex=1,this.pageSize=0,this.perPageSize=3,this.controlLoadingPos(),this.videoPreviewBox(),this.locationMapBox(),this.initImgPercent(),this.controlCommentInputStyle(),this.controlCoverFootStyle(),this.extendJqueryForScroll(),this.loadBasicInfoData(),this.loadTopAnnouncement(),this.loadSignUpInfo();var r=getDeviceType(),i="touchend";r.mobile?this.$wrapper.find(".btn").on("touchstart",function(){}):i="click",this.$wrapper.find("#videoPreviewBox img").bind("load",$.proxy(this,"controlPlayBtnStyle")),this.$wrapper.scroll($.proxy(this,"scrollContainer"));var s=[this.loadBasicInfoData,this.loadTopAnnouncement,this.loadSignUpInfo,this.loadMyVideoInfo,this.loadMyTeachersInfo,this.loadMyCompresAsseinfo,this.loadDetailCommentInfo];this.$wrapper.on(i,".loadErrorCon a",function(){var e=$(this).data("index")|0,t=s[e];t&&t.call(n)})}return e.prototype={controlLoadingPos:function(){var e=$(".loadingResultTips"),t=$("body"),n=e.width(),r=e.height(),i=t.width(),s=t.height();e.css({top:(s-r)/2,left:(i-n)/2,opacity:"1"})},videoPreviewBox:function(){var e=this.$wrapper.find("#videoPreviewBox"),t=this.$wrapper.width()-30,n=parseInt(t*(9/16)),r=e.find("i"),i=r.height(),s=r.width();this.$wrapper.find("#videoPreviewBox").css("height",n),r.css({top:(n-i)/2,left:(t-s)/2})},locationMapBox:function(){var e=this.$wrapper.find(".mainItemLocation"),t=this.$wrapper.width(),n=parseInt(t*(7/16)),r=e.find("i"),i=r.height(),s=r.width();this.$wrapper.find("#locationMap").css("height",n)},controlPlayBtnStyle:function(){var e=this.$wrapper.find("#videoPreviewBox img"),t=e.width(),n=e.height(),r=e.next(),i=r.height(),s=r.width();r.css({top:(n-i)/2,left:(t-s)/2})},controlCommentInputStyle:function(){var e=this.$wrapper.find("#myComment"),t=this.$wrapper.width()-35;e.css("width",t+"px")},loadData:function(e){e.type||(e.type="get");var t=this;t.controlLoadingTips(1);var n=$.ajax({url:e.url,type:e.type,data:e.paraData,timeOut:10,contentType:"application/json;charset=utf-8",complete:function(r,i){if(i=="success"){var s=r.responseText,o={};s?o=JSON.parse(r.responseText):o.status=!1;if(o.success)t.controlLoadingTips(0),e.sCallback(JSON.parse(r.responseText));else{var u=o.message;e.eCallback&&e.eCallback(u),t.controlLoadingTips(0)}}else i=="timeout"?(n.abort(),t.controlLoadingTips(0),e.eCallback()):(t.controlLoadingTips(0),e.eCallback())}})},loadBasicInfoData:function(){var e=this,t=e.$wrapper.find(".logoAndCertInfo"),n={url:window.urlObject.apiUrl+"appGetBaseInfo",paraData:{organization_id:this.oid},sCallback:$.proxy(this,"fillInBasicInfoData"),eCallback:function(){t.css("opacity",1),t.find(".loadErrorCon").show()}};this.loadData(n)},fillInBasicInfoData:function(e){var t=e.data,n=t.authenticationInfo[2].status,r=n?"certed":"unCerted",i=t.authenticationInfo[3].status,s=i?"certed":"unCerted",o=t.logo;getDeviceType().android&&(o=window.urlObject.image+"/orgbasicinfo/blur.jpg");var u='<div class="head mainContent"><div class="filter"><img class="logoBg myLogo" src="'+o+'" alt="logo"/>'+'<div class="filterUp"></div>'+"</div>"+'<div class="mainInfo">'+'<div class="left">'+'<img id="myLogo" class="myLogo" src="'+t.logo+'" />'+"</div>"+'<div class="right">'+'<div id="orgName">'+t.name+"</div>"+'<div class="peopleInfo">'+'<div class="peopleInfoItem">'+'<div class="valInfo" id="viewedVal">'+t.view_count+"</div>"+'<div class="filedInfo">查看人数</div>'+"</div>"+'<div class="peopleInfoItem">'+'<div class="valInfo" id="teacherdVal">'+t.teachersCount+"</div>"+'<div class="filedInfo">老师</div>'+"</div>"+'<div class="peopleInfoItem">'+'<div class="valInfo" id="fansVal">'+t.followCount+"</div>"+'<div class="filedInfo">粉丝</div>'+"</div>"+'<div class="peopleInfoItem">'+'<div class="valInfo" id="groupsVal">'+t.groupCount+"</div>"+'<div class="filedInfo">群主</div>'+"</div>"+'<div style="clear: both;"></div>'+"</div>"+"</div>"+"</div>"+"</div>"+'<div class="bottom">'+'<div class="cerInfoItem '+r+'">'+"<span>"+'<i class="heiCerIcon spiteBg '+r+'"></i>'+'<span class="cerName '+r+'">嘿设汇认证</span>'+'<div style="clear: both;"></div>'+"</span>"+"</div>"+'<div class="cerInfoItem  '+s+'">'+"<span>"+'<i class="honestCerIcon spiteBg '+s+'"></i>'+'<span class="cerName '+r+'">诚信机构认证</span>'+'<div style="clear: both;"></div>'+"</span>"+"</div>"+"</div>";this.$wrapper.find(".logoAndCertInfo").html(u).css("opacity",1),this.$wrapper.find("#myLogo").setImgBox(),this.fillInIntroduceInfo(e)},loadTopAnnouncement:function(){var e=this,t=e.$wrapper.find(".mainItemTopNews");this.loadData({url:window.urlObject.apiUrl+"topPost",paraData:{organization_id:this.oid},sCallback:function(n){t.css("opacity",1),e.fillInTopAnnouncement(n.data)},eCallback:function(e){t.css("opacity",1),t.find(".loadErrorCon").show().find("a").text("获取头条信息失败，点击重新加载").show()}})},fillInTopAnnouncement:function(e){var t="",n;if(!e||e.length==0)t='<li><div class="nonData">暂无头条信息</div></li>';else{var r=e.length;for(var i=0;i<r;i++)n=e[i],t+='<li><div class="topNewLogo">头条</div><div class="title"><a href="'+n.detail_url+'">'+n.title+"</a>"+"</div>"+"</li>"}this.$wrapper.find(".mainItemTopNews .mainContent").html(t)},loadSignUpInfo:function(){var e=this,t=e.$wrapper.find(".mainItemSignUp");this.loadData({url:window.urlObject.apiUrl+"enrollList",paraData:{organization_id:this.oid},sCallback:function(n){t.css("opacity",1),t.find("#leftSingUpNum").text(n.available_count),e.fillInSignUpInfo(n.data)},eCallback:function(e){t.css("opacity",1),t.find(".loadErrorCon").show().find("a").text("获取报名信息失败，点击重新加载").show()}})},fillInSignUpInfo:function(e){var t="",n,r=!e||e.length==0;if(r)t='<div class="nonData">暂无人员报名</div>';else{var i=e.length,s=Math.ceil(i/3)*3-i;for(var o=0;o<i;o++){n=e[o];var u=(new Date(n.create_time*1e3)).format("yyyy-MM-dd");t+='<li><span class="dot">&middot;</span><span>'+n.student_name+"</span>"+"<span>&nbsp;&nbsp;同学于</span>"+"<span>&nbsp;&nbsp;"+u+"</span>"+"<span>&nbsp;&nbsp;成功报名</span>"+"</li>"}for(var o=0;o<s;o++)t+="<li></li>"}this.$wrapper.find(".mainItemSignUp .signUpConUl").html(t),!r&&e.length>3&&this.$wrapper.find(".signUpCon").Scroll({line:3,speed:2500,timer:2500,up:"btn1",down:"btn2"})},fillInIntroduceInfo:function(e){var t=this.$wrapper.find(".mainItemBasicInfo"),n=this.$wrapper.find(".mainItemLocation");t.add(n).css("opacity","1");if(e&&e.data){var r=e.data,i=r.introduce,s=r.advantage,o=r.location,u=r.location_img;i&&t.find(".introduce").html("<p>"+i+"</p>");if(s){var a=s.split("#"),f="";for(var l=0;l<a.length;l++)f+="<li>"+a[l]+"</li>";t.find(".itemContentDetail").html(f)}o||n.find("#myLocation").text(o),u?n.find(".locationMap img").attr("src",u):n.find(".noDataInHeader").html("&nbsp;&nbsp;&nbsp;&nbsp;地址信息暂无")}},loadMyTeachersInfo:function(e){var t=this,n=t.$wrapper.find(".mainItemTeacherPower");this.loadData({url:window.urlObject.apiUrl+"appGetTeacherList",paraData:{organization_id:this.oid},sCallback:function(r){n.css("opacity",1),t.fillMyTeachersInfo(r.teacherList),e&&e()},eCallback:function(t){n.css("opacity",1),n.find(".loadErrorCon").show().find("a").text("获得教师信息失败，点击重新加载").show(),e&&e()}})},fillMyTeachersInfo:function(e){var t="",n;if(!e||e.length==0)t='<div class="nonData">暂无老师</div>';else{var r=e.length,i=r%2==0,s="border";for(var o=0;o<r;o++)i&&o>=r-2&&(s="unBorder"),!i&&o>=r-1&&(s="unBorder"),n=e[o].info,t+='<li class="'+s+'">'+'<div class="leftPic">'+'<img src="'+n.avatar128+'"/>'+"</div>"+'<div class="rightUserInfo">'+'<div class="name">'+n.nickname+"</div>"+'<div class="desc">'+n.institution.substrLongStr(12)+"</div>"+"</div>"+"</li>"}this.$wrapper.find(".mainItemTeacherPower .teacherPowerDetail").prepend(t)},loadMyVideoInfo:function(e){var t=this,n=t.$wrapper.find(".videoPreview");this.loadData({url:window.urlObject.apiUrl+"getPropagandaVideo",paraData:{organization_id:this.oid},sCallback:function(n){if(n.success){var r=n.data.video_img;r?t.$wrapper.find("#videoPreview").attr("src",n.data.video_img):t.$wrapper.find(".videoCon .itemHeader span").text("视频信息暂无"),e()}else t.$wrapper.find(".noDataInHeader").text("视频信息暂无")},eCallback:function(t){n.css("opacity",1),n.find(".loadErrorCon").show().find("a").text("获取视频信息失败，，点击重新加载").show(),e()}})},loadMyCompresAsseinfo:function(e){var t=this,n=t.$wrapper.find(".mainItemCompresAsse");this.loadData({url:window.urlObject.apiUrl+"fractionalStatistics",paraData:{organization_id:this.oid},sCallback:function(r){n.css("opacity",1),t.fillMyCompresAsseInfo(r),e&&e()},eCallback:function(t){n.css("opacity",1),n.find(".loadErrorCon:eq(0)").show().find("a").text("获取评价信息失败，点击重新加载").show(),e&&e()}})},fillMyCompresAsseInfo:function(e){var t=e.data;if(!t||t.length==0)return;var n="",r=this,i,s=this.$wrapper.find(".mainItemCompresAsse"),o=s.find(".basicHeader"),u=s.find(".assessmentDetail li"),a=this.getStarInfoByScore(e.comprehensiveScore);o.find("#myAssessment").text(e.comprehensiveScore),o.find("#starsConForCompress").prepend(a);for(var f=0;f<t.length;f++)i=t[f],u.each(function(){var e=$(this),t=r.getColorBlockInfoByScore(i.score);if(e.find(".title").text()==i.value)return e.find(".score").text(i.score),e.find(".fillIn").addClass(t.cName).css("width",t.width+"%").next().css("width",100-t.width+"%"),!1})},loadDetailCommentInfo:function(e,t){var n=this,r=n.$wrapper.find(".studentCommentCon");this.loadData({url:window.urlObject.apiUrl+"commentList",paraData:{organization_id:this.oid,page:e,count:n.perPageSize},sCallback:function(e){n.pageSize=Math.ceil((e.totalCount|0)/n.perPageSize),n.$wrapper.find("#commentNum").text(e.totalCount),n.fillDetailCommentInfo(e),t&&t.call(n)},eCallback:function(e){r.find(".loadErrorCon:eq(1)").show().find("a").text("获取评论信息失败，点击重新加载").show(),t&&t.call(n)}})},fillDetailCommentInfo:function(e){var t=e.data,n="";if(!t||t.length==0)n='<li><div class="nonData">暂无评论</div></li>',this.$wrapper.find(".studentCommentDetail li").remove();else{var r=t.length,i,s,o;for(var u=0;u<r;u++)i=t[u],s=i.userInfo,o=this.getDiffTime(new Date(i.create_time*1e3)),n+='<li><div class="imgCon"><div><img src="'+s.avatar128+'"/></div>'+"</div>"+'<div class="commentCon">'+'<div class="commentHead">'+'<span class="commentNickname">'+s.nickname+"</span>"+'<span class="rightItem starsCon">'+this.getStarInfoByScore(i.comprehensive_score|0)+'<div style="clear: both;"></div>'+"</span>"+"</div>"+'<div class="content">'+i.comment+"</div>"+'<div class="publicTime">发表于'+o+"</div>"+"</div>"+"</li>"}this.$wrapper.find(".studentCommentDetail").append(n)},controlLoadingTips:function(e){var t=$("#loadingTip"),n=t.find(".loadingImg");e==1?(t.css("z-index",1),n.addClass("active")):(t.css("z-index",-1),n.removeClass("active"))},scrollContainer:function(e){var t=e.currentTarget,n=t.scrollHeight-$(t).height(),r=$(t).scrollTop(),i=[300,550],s=this.$wrapper.find(".mainItemTeacherPower"),o=this.$wrapper.find(".mainItemCompresAsse");if(r>=i[0]&&r<i[1]&&s.attr("data-loading")=="false"&&s.attr("data-loaded")=="false"){var u=s.attr("data-loaded");s.attr("data-loading","true"),u=="false"&&(this.loadMyTeachersInfo(function(){s.attr({"data-loaded":"true","data-loading":"false"})}),this.loadMyVideoInfo(function(){s.prev().find(".videoCon").attr({"data-loaded":"true","data-loading":"false"})}));return}if(r>=i[1]&&o.attr("data-loading")=="false"&&o.attr("data-loaded")=="false"){var u=o.attr("data-loaded");o.attr("data-loading","true"),"false"==u&&(this.loadMyCompresAsseinfo(function(){o.attr({"data-loaded":"true","data-loading":"false"})}),this.loadDetailCommentInfo(this.pageIndex,function(){o.attr({"data-loaded":"true","data-loading":"false"}),this.pageIndex++}));return}},initImgPercent:function(){$.fn.setImgBox=function(){if(this.length==0)return;var e=this,t=new Image;return t.src=this[0].src,t.onload=function(){var n=t.height,r=t.width,i=e.css("max-height"),s=e.css("max-width");!i||i=="none"?i=e.parent().height():i=i.replace("px",""),!s||s=="none"?s=e.parent().width():s=s.replace("px","");var o=n>i,u=r>s,a=1;if(o||u){var f=i/n,l=s/r;f<l?(n=i,r*=f,a=f):(r=s,n*=l,a=l)}e.css({width:r+"px",height:n+"px","margin-top":(e.parent().height()-n)/2+"px"}).attr("data-radio",a)},this}},getStarInfoByScore:function(e){e.toString().indexOf(".")>0&&(e=this.myRoundNumber(e));var t="",n=Math.floor(e),r=Math.ceil(e),i=r==n?0:1,s=5-r;for(var o=0;o<n;o++)t+='<i class="allStar spiteBgOrigin"></i>';i==1&&(t+='<i class="halfStar spiteBgOrigin"></i>');for(var o=0;o<s;o++)t+='<i class="emptyStar spiteBgOrigin"></i>';return t},myRoundNumber:function(e){e=e.toFixed(1);var t=e.split("."),n=t[0],r=t[1];if(r!=0){var i=r<=2,s=r>=7;return i?n|0:s?n|1:parseInt(n)+.5}},getColorBlockInfoByScore:function(e){var t=[{min:0,max:2,cName:"greenFillIn"},{min:2,max:4,cName:"yellowFillIn"},{min:4,max:5.000000001,cName:"redFillIn"}],n=$.grep(t,function(t,n){return e>=t.min&&e<t.max})[0];return{cName:n.cName,width:Math.ceil(e/5*100)}},controlCoverFootStyle:function(){var e=$("#downloadCon"),t=e.find("a"),n=t.width(),r=n*.4,i=e.width(),s=i*102/750;e.css({height:s+"px",left:($("body").width()-i)/2}),this.$wrapper.css("bottom",s+"px");var o="16px";i<375&&(o="14px"),t.css({top:(s-r)/2,height:r+"px","line-height":r+"px","font-size":o})},getDiffTime:function(e){if(e){var t=6e4,n=t*60,r=n*24,i=new Date-e,s="";if(i<0)return s;var o=i/(7*r),u=i/r,a=i/n,f=i/t;return o>=1?(s=e.getFullYear()+"."+(e.getMonth()+1)+"."+e.getDate(),s):u>=1?(s=parseInt(u)+"天前",s):a>=1?(s=parseInt(a)+"小时前",s):f>=1?(s=parseInt(f)+"分钟前",s):(s="刚刚",s)}return""},extendJqueryForScroll:function(){$.extend($.fn,{Scroll:function(e,t){if(!e)var e={};var n,r=this.eq(0).find("ul"),i=r.find("li"),s=i.eq(0).height(),o=e.line?parseInt(e.line,10):parseInt(this.height()/s,10),u=e.speed?parseInt(e.speed,10):500,a=e.timer;o==0&&(o=1);var f=0-o*s,l=function(){r.animate({marginTop:f},500,"ease-out",function(){for(var e=1;e<=o;e++)r.find("li").eq(0).appendTo(r);r.css({marginTop:0})})},c=function(){a&&(n=window.setInterval(l,a))};c()}})}},e});